@model Sald.Data.Data.Data.Apartment
@using Sald.Data.HelperClass



@{
    Layout = "~/Views/Shared/_LayoutApartment.cshtml";
    // ViewData["Title"] = "Apartament";
}


@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        @TempData["Success"]
    </div>
}



@section Styles {
    <link rel="stylesheet" href="~/css/photoCollage.css" asp-append-version="true" />
}
<div class="page-bg"></div>
<!-- ================== Galeria ================== -->


<section class="top-background">
    <div class="container collage-container">

        <h2 class="mt-4 ml-4 ml-md-0 mb-3 apartment-title">
            Apartament Słoneczny
        </h2>

        <div class="collage-wrapper">

            <!-- LEWA STRONA – DUŻE ZDJĘCIE -->
            <div class="left-column">
                <div class="large-photo photo-frame">
                    <img src="@FileAction.GetImg(Model.Photos[0])" alt="Apartament – główne zdjęcie">
                </div>

                <!-- te miniatury są widoczne tylko na desktop -->
                <div class="small-photos">
                    <img src="@FileAction.GetImg(Model.Photos[1])" alt="">
                    <img src="@FileAction.GetImg(Model.Photos[2])" alt="">
                    <img src="@FileAction.GetImg(Model.Photos[3])" alt="">
                </div>
            </div>

            <!-- PRAWA STRONA – 3 ZDJĘCIA -->
            <div class="right-column photo-frame">
                <img src="@FileAction.GetImg(Model.Photos[1])" alt="">
                <img src="@FileAction.GetImg(Model.Photos[2])" alt="">
                <img src="@FileAction.GetImg(Model.Photos[3])" alt="">
            </div>

        </div>
    </div>
</section>


<!-- Fullscreen gallery overlay -->
<div id="galleryOverlay" class="gallery-overlay">
    <span class="gallery-close">&times;</span>
    <img id="galleryFull" src="" class="gallery-full" />
    <div class="gallery-controls">
        <span class="prev">&#10094;</span>
        <span class="next">&#10095;</span>
    </div>
    <div id="galleryCounter" class="gallery-counter"></div>
</div>

<!-- Ukryta lista wszystkich zdjęć do galerii -->
<div id="allPhotos" style="display:none;">
    @for (int i = 0; i < Model.Photos.Count; i++)
    {
        <img src="@FileAction.GetImg(Model.Photos[i])" data-index="@i" />
    }
</div>




<!-- ================== INFORMACJE ================== -->
<section class="top-background">

    <div class="container mt-4">
        <div class="content-wrap">
            <div class="row">
                <div class="col-md-8 main-text mb-0 mb-md-4">
                    <h3>Opis</h3>
                    <p class="card-text">@Html.Raw(Model.Opis)</p>
                </div>

                <div class="col-md-4 mt-0 mt-md-4">

                    <div class="row gy-4">
                        <div class="col-12">
                            <div class="card card-apart">
                                <div class="card-body">
                                    <h4>Informacje podstawowe</h4>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>Piętro:</strong> @Model.Pietro</li>
                                        <li class="list-group-item"><strong>Liczba pięter w budynku:</strong> @Model.LiczbaPieterWBudynku</li>
                                        <li class="list-group-item"><strong>Metraż:</strong> @Model.Metraz m²</li>
                                        <li class="list-group-item"><strong>Liczba pokoi:</strong> @Model.LiczbaPokoi</li>
                                    </ul>



                                    <ul class="list-group list-group-flush mt-3">

                                        @if (Model.Balkon)
                                        {
                                            <li class="list-group-item">Balkon</li>
                                        }
                                        @if (Model.Winda)
                                        {
                                            <li class="list-group-item">Winda</li>
                                        }
                                        @if (Model.Piwnica)
                                        {
                                            <li class="list-group-item">Piwnica</li>
                                        }
                                        @if (Model.OgrzewaniePodlogowe)
                                        {
                                            <li class="list-group-item">Ogrzewanie podłogowe</li>
                                        }
                                        @if (Model.Klimatyzacja)
                                        {
                                            <li class="list-group-item">Klimatyzacja</li>
                                        }
                                        @if (Model.Garaz)
                                        {
                                            <li class="list-group-item">Garaż</li>
                                        }
                                        @if (Model.MiejsceParkingoweNaZewnatrz)
                                        {
                                            <li class="list-group-item">Miejsce parkingowe na zewnątrz</li>
                                        }
                                        @if (Model.Ogrod)
                                        {
                                            <li class="list-group-item">Ogród</li>
                                        }
                                        @if (Model.Taras)
                                        {
                                            <li class="list-group-item">Taras</li>
                                        }
                                        @if (Model.WcRazemZLazienka)
                                        {
                                            <li class="list-group-item">WC razem z łazienką</li>
                                        }
                                    </ul>

                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card card-apart">
                                <div class="card-body">
                                    <h4>Adres</h4>
                                    <ul class="list-unstyled">
                                        <li><strong>Ulica:</strong> @Model.Ulica @Model.NumerBudynku/@Model.NumerMieszkania</li>
                                        <li><strong>Miasto:</strong> @Model.Miasto</li>
                                        <li><strong>Kod pocztowy:</strong> @Model.KodPocztowy</li>
                                        <li><strong>Kraj:</strong> @Model.Kraj</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card card-apart">
                                <div class="card-body">
                                    <h4>Kontakt</h4>
                                    <ul class="list-unstyled">
                                        <li><strong>Email:</strong> @Model.Email</li>
                                        <li><strong>Telefon 1:</strong> @Model.Telefon1</li>
                                        <li><strong>Telefon 2:</strong> @Model.Telefon2</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<section class="">
    <div class="container text-center py-5">
        <h3>Skontaktuj się z nami!</h3>
        <p>Zapytaj o apartament lub umów się na wizytę.</p>
        <a href="tel:+48123456789" class="btn-call mt-3">
            <svg width="20" height="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.15 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.08 4.18 2 2 0 0 1 4 2h3a2 2 0 0 1 2 1.72c.12 1.05.37 2.07.75 3.02a2 2 0 0 1-.45 2.11L8.09 10.91a16 16 0 0 0 6 6l1.09-1.09a2 2 0 0 1 2.11-.45c.95.38 1.97.63 3.02.75a2 2 0 0 1 1.72 2z"></path>
            </svg>
            Zadzwoń
        </a>
    </div>
</section>

<section class="top-background">
    <div class="container mt-4">
        <div class="content-wrap">
            <div class="row justify-content-center">
                <div class="col-md-12">

                    <div class="card card-apart mt-4">
                        <div class="card-body">
                            <h4>Wyślij wiadomość</h4>
                            <div id="mailResult"></div>

                            <form id="apartmentForm">
                                <input type="hidden" name="ApartmentId" value="@Model.ApartmentID" />

                                <div class="row g-3">
                                    <div class="col-md-4 col-12">
                                        <div class="mb-3">
                                            <label for="Name" class="form-label">Imię</label>
                                            <input type="text" class="form-control" name="Name" required />
                                        </div>

                                        <div class="mb-3">
                                            <label for="Email" class="form-label">Email</label>
                                            <input type="email" class="form-control" name="Email" required />
                                        </div>

                                        <div class="mb-3">
                                            <label for="Phone" class="form-label">Telefon</label>
                                            <input type="text" class="form-control" name="Phone" />
                                        </div>
                                    </div>

                                    <div class="col-md-8 col-12">
                                        <div class="mb-3 h-100 d-flex flex-column">
                                            <label for="Message" class="form-label">Wiadomość</label>
                                            <textarea class="form-control flex-grow-1" name="Message" rows="6" required></textarea>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn-call mt-3">Wyślij</button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>



<section class="section-muted bottom-background">

    <div class="container">
        @{
            var address = Model.PelnyAdres;
        }
        <div class="row">
            <div class="col-md-8 mb-4 mb-md-0">
                <iframe 
                        style="border:0; border-radius:1rem; width:100%; min-height:350px; height:100%;"
                        loading="lazy"
                        allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://www.google.com/maps?q=@address&output=embed">
                </iframe>
            </div>

            <div class="col-md-4 mt-4 mt-md-0">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <img src="@Url.Action("Generate", "QR")" alt="Kod QR strony" style="width: 100%; height: 100%; object-fit: cover;" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>



@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("apartmentForm");
            const resultDiv = document.getElementById("mailResult");

            form.addEventListener("submit", function(e) {
                e.preventDefault();

                const formData = new FormData(form);

                fetch('@Url.Action("SendMailAjax")', {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        form.reset();
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    }
                })
                .catch(() => {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Wystąpił błąd. Spróbuj ponownie.</div>`;
                });
            });


               //gallery

            const images = document.querySelectorAll("#allPhotos img");
            const overlay = document.getElementById("galleryOverlay");
            const full = document.getElementById("galleryFull");
            const counter = document.getElementById("galleryCounter");

            let current = 0;
            const total = images.length;

            function openGallery(index){
                current = index;
                update();
                overlay.classList.add("active");
            }

            function closeGallery(){
                overlay.classList.remove("active");
            }

            function update(){
                full.src = images[current].getAttribute("src");
                counter.textContent = `${current + 1} / ${total}`;
            }

            // Kliknięcie w kolaż
            document.querySelectorAll(".photo-frame img").forEach(img => {
                img.addEventListener("click", () => {
                    const src = img.getAttribute("src");
                    const index = Array.from(images).findIndex(i => i.getAttribute("src") === src);
                    if(index >= 0) openGallery(index);
                });
            });

            // Close
            document.querySelector(".gallery-close").onclick = closeGallery;

            // Prev / Next
            document.querySelector(".prev").onclick = () => {
                current = (current - 1 + total) % total;
                update();
            };
            document.querySelector(".next").onclick = () => {
                current = (current + 1) % total;
                update();
            };

            // Keyboard
            document.addEventListener("keydown", e => {
                if(e.key === "Escape") closeGallery();
                if(e.key === "ArrowLeft") document.querySelector(".prev").click();
                if(e.key === "ArrowRight") document.querySelector(".next").click();
            });

            // Swipe mobile
            let startX = 0;
            let endX = 0;
            full.addEventListener("touchstart", e => startX = e.touches[0].clientX);
            full.addEventListener("touchmove", e => endX = e.touches[0].clientX);
            full.addEventListener("touchend", () => {
                const diff = endX - startX;
                if(Math.abs(diff) > 50){
                    if(diff > 0) document.querySelector(".prev").click();
                    else document.querySelector(".next").click();
                }
                startX = 0;
                endX = 0;
            });


        });


    </script>

}
