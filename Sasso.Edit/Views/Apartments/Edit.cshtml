@model Sald.Data.Data.Data.Apartment
@using Sald.Data.HelperClass

@{
    ViewData["Title"] = "Edytuj Apartament";
}

<h2>@ViewData["Title"]</h2>

<script type="text/javascript">
    bkLib.onDomLoaded(function () { nicEditors.allTextAreas() });
</script>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ApartmentID" />

    <div class="row">
        <!-- ================== Informacje podstawowe ================== -->
        <div class="col-12 mb-3">
            <div class="form-group">
                <label asp-for="Nazwa"></label>
                <input asp-for="Nazwa" class="form-control" />
                <span asp-validation-for="Nazwa" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Opis"></label>
                <textarea rows="35" asp-for="Opis" class="form-control"></textarea>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <h4>Informacje podstawowe</h4>
            <div class="form-group">
                <label asp-for="Pietro"></label>
                <input asp-for="Pietro" type="number" class="form-control" />
            </div>
            <div class="form-group">
                <label asp-for="LiczbaPieterWBudynku"></label>
                <input asp-for="LiczbaPieterWBudynku" type="number" class="form-control" />
            </div>
            <div class="form-group">
                <label asp-for="Metraz"></label>
                <input asp-for="Metraz" type="number" step="0.1" class="form-control" />
            </div>
            <div class="form-group">
                <label asp-for="LiczbaPokoi"></label>
                <input asp-for="LiczbaPokoi" type="number" class="form-control" />
            </div>
        </div>

        <!-- ================== Adres ================== -->
        <div class="col-md-6 mb-3">
            <h4>Adres</h4>
            <div class="form-group">
                <label asp-for="Ulica"></label>
                <input asp-for="Ulica" class="form-control" />
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label asp-for="NumerBudynku"></label>
                        <input asp-for="NumerBudynku" class="form-control" />
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label asp-for="NumerMieszkania"></label>
                        <input asp-for="NumerMieszkania" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label asp-for="Miasto"></label>
                        <input asp-for="Miasto" class="form-control" />
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label asp-for="KodPocztowy"></label>
                        <input asp-for="KodPocztowy" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label asp-for="Kraj"></label>
                <input asp-for="Kraj" class="form-control" />
            </div>
        </div>

        <!-- ================== Udogodnienia ================== -->
        <div class="col-md-6 mb-3">
            <h4>Udogodnienia</h4>
            <div class="row mt-3">
                @foreach (var prop in new[]
                                {
                                nameof(Model.WcRazemZLazienka),
                                nameof(Model.Balkon),
                                nameof(Model.Winda),
                                nameof(Model.Piwnica),
                                nameof(Model.OgrzewaniePodlogowe),
                                nameof(Model.Klimatyzacja),
                                nameof(Model.Garaz),
                                nameof(Model.MiejsceParkingoweNaZewnatrz),
                                nameof(Model.Ogrod),
                                nameof(Model.Taras)
                                })
                {
                    <div class="col-md-6">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input"
                                   name="@prop"
                                   value="true"
                                   @(Model.GetType().GetProperty(prop).GetValue(Model).Equals(true) ? "checked" : "") />
                            <label class="form-check-label">@prop</label>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- ================== Kontakt ================== -->
        <div class="col-md-6 mb-3">
            <h4>Kontakt</h4>
            <div class="form-group">
                <label asp-for="Email"></label>
                <input asp-for="Email" class="form-control" />
            </div>
            <div class="form-group">
                <label asp-for="Telefon1"></label>
                <input asp-for="Telefon1" class="form-control" />
            </div>
            <div class="form-group">
                <label asp-for="Telefon2"></label>
                <input asp-for="Telefon2" class="form-control" />
            </div>
        </div>

        <!-- ================== ZDJĘCIA ================== -->
        <div class="col-12 mb-3">
            <h4>Zdjęcia</h4>

            <!-- ISTNIEJĄCE -->
            <div id="existingPhotos" class="d-flex flex-wrap justify-content-center mb-3">
                @foreach (var photo in Model.Photos)
                {
                    <div class="preview-item">
                        <img src="@FileAction.GetImg(photo)" style="width:100%; height:100%; object-fit:cover;" />
                        <button type="button"
                                class="close-btn delete-photo"
                                data-id="@photo.FileID">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                    </div>
                }
            </div>

            <!-- NOWE -->
            <input type="file" id="FormFileItems" name="FormFileItems" multiple class="form-control mb-2" />
            <div id="preview" class="d-flex flex-wrap justify-content-center"></div>

            <button type="submit" class="btn btn-primary mt-3">Zapisz zmiany</button>
        </div>
    </div>
</form>

@section Scripts {

    <style>
        .preview-item {
            position: relative;
            width: 33.33%;
            min-width: 190px;
            aspect-ratio: 1/1;
            overflow: hidden;
            padding: 4px;
        }

        .close-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .preview-item:hover .close-btn {
            opacity: 1;
        }
    </style>

    <script>
        // ================== Dopasowanie ikon X ==================
        function resizeIcons() {
            document.querySelectorAll('.preview-item').forEach(div => {
                const icon = div.querySelector('i');
                if(icon) icon.style.fontSize = (Math.min(div.clientWidth, div.clientHeight)*0.3)+'px';
            });
        }
        window.addEventListener('resize', resizeIcons);
        window.addEventListener('load', resizeIcons);

        // ================== USUWANIE ISTNIEJĄCYCH ZDJĘĆ ==================
        function setupDeleteButtons() {
            document.querySelectorAll('.delete-photo').forEach(btn => {
                btn.onclick = async () => {
                    const fileId = btn.dataset.id;
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    const formData = new FormData();
                    formData.append("id", fileId);
                    formData.append("__RequestVerificationToken", token);

                    try {
                        const res = await fetch('@Url.Action("DeletePhoto", "Apartments")', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await res.json();
                        if(data.success) btn.parentElement.remove();
                        else alert("Nie udało się usunąć zdjęcia.");
                    } catch {
                        alert("Błąd połączenia z serwerem.");
                    }
                };
            });
        }
        setupDeleteButtons();

        // ================== PREVIEW I DODAWANIE NOWYCH ZDJĘĆ AJAX ==================
        const input = document.getElementById('FormFileItems');
        const preview = document.getElementById('preview');
        const existingPhotosContainer = document.getElementById('existingPhotos');
        const apartmentId = '@Model.ApartmentID';
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        input.addEventListener('change', () => {
            if(input.files.length===0) return;

            const formData = new FormData();
            for(const file of input.files) formData.append('files', file);
            formData.append('apartmentId', apartmentId);
            formData.append('__RequestVerificationToken', token);

            fetch('@Url.Action("AddPhotos", "Apartments")', { method:'POST', body: formData })
            .then(res => res.json())
            .then(response => {
                if(response.success){
                    response.files.forEach(f=>{
                        const div = document.createElement('div');
                        div.classList.add('preview-item');

                        const img = document.createElement('img');
                        img.src = f.url;
                        img.style.width='100%';
                        img.style.height='100%';
                        img.style.objectFit='cover';
                        div.appendChild(img);

                        const btn = document.createElement('button');
                        btn.type='button';
                        btn.classList.add('close-btn','delete-photo');
                        btn.dataset.id = f.fileId;
                        btn.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
                        div.appendChild(btn);

                        existingPhotosContainer.appendChild(div);
                    });
                    setupDeleteButtons(); // przypisanie zdarzeń do nowych przycisków
                    resizeIcons();
                } else alert("Nie udało się dodać zdjęć.");
            })
            .catch(()=>alert("Błąd połączenia z serwerem."));

            input.value=''; // reset input
        });
    </script>

}
